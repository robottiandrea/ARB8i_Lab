<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Doodles Overlays â€” Gallery</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./styles/common.css">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f1115">

<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Doodles">

<!-- libreria condivisa: mountIdRow, initIdControl, normalizeId, createIdPreview -->

<script src="./scripts/common.js?v=3"></script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
</script>

<style>
  :root{
    /* solo variabili/parametri usati QUI (non in common) */
    --footer-space: calc(44px + env(safe-area-inset-bottom));
    --card-w:256px;
    --gap:18px;

    /* params sheen chip */
    --sheen-width:56px;
    --sheen-alpha:.18;
    --sheen-angle:-14deg;
    --sheen-from:-120%;
    --sheen-to:220%;
    --sheen-dur:5.2s;
    --sheen-delay:1.2s;
  }

  *{box-sizing:border-box}

  body{
    min-height:100svh;
    display:flex;
    flex-direction:column;
  }
  .wrap{ flex:1 0 auto; }

  /* hero */
  .hero{ text-align:center; margin:8px 0 18px }
  /* HERO: font fisse */
  .hero h1{
    margin:0 0 8px;           /* unifica i due .hero h1 che avevi (6px e 8px) */
    font-size: 40px;          /* fisso (oppure 2rem se preferisci) */
    font-weight:600;
  }
  .hero p{
    margin:0;
    font-size: 15px;          /* fisso */
    line-height:1.35;
    color:var(--muted);
  }
  .hero .tagline{
    margin:10px 0 0;
    font-size: 20px;          /* fisso */
    line-height:1.35;
    color:var(--muted);
  }

  .hero .sub{ margin-top: 8px !important; }

  /* griglia cards */
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-w), var(--card-w)));
    gap:var(--gap);
    justify-content:center;
    justify-items:center;
    max-width: calc(3 * var(--card-w) + 2 * var(--gap));
    margin-inline:auto;
  }

  /* parti di card specifiche della gallery (il resto sta in common.css) */
  .thumb{ position:relative; aspect-ratio:1/1; background:#0d1016; }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .badge{
    position:absolute; top:8px; left:8px;
    padding:4px 8px; border-radius:10px; font-size:11px; font-weight:600;
    background:#fff; color:#0F1116;
  }
  .titlebar{ padding:10px 12px; border-top:1px solid var(--border);
             background:linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.15)); }
  .name{ font-size:15px; font-weight:600 }
  .by{ font-size:12px; color:var(--muted) }
  a.cardlink{ position:absolute; inset:0; display:block; text-decoration:none; color:inherit }
  .empty{ opacity:.8; text-align:center; border:1px dashed var(--border); border-radius:12px; padding:18px }

  /* nav chip sticky (solo gallery) */
  .navchip-bar{
    position:sticky;
    top:calc(12px + env(safe-area-inset-top));
    z-index:9999;
    display:flex; justify-content:center; padding:4px 0;
  }
  .navchip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 14px; border-radius:999px;
    background: rgba(23,26,33,.85);
    background: color-mix(in oklab, var(--card) 85%, transparent);
    border:1px solid var(--border);
    backdrop-filter: blur(8px);
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    font:600 14px/1 'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text); text-decoration:none; white-space:nowrap;
    transition:border-color .15s ease, color .15s ease, transform .05s ease;
    position:relative; overflow:hidden;
  }
  .navchip:hover{ color:var(--acc); border-color:var(--acc); }
  .navchip:active{ transform: translateY(1px); }


  
  /* Glow forte + onda sulle card (solo gallery) */
  .grid.highlight .card::after{
    content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none; z-index:2;
    box-shadow:
      inset 0 0 0 3px rgba(138,180,255,.75),
      0 0 22px rgba(138,180,255,.45),
      0 0 44px rgba(138,180,255,.25);
    opacity:0; animation: glowPulse 1.6s ease-in-out forwards; animation-delay: var(--delay, 0s);
  }
  @keyframes glowPulse{
    0%{ opacity:0; box-shadow: inset 0 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0); }
    18%{ opacity:1; box-shadow: inset 0 0 0 3px rgba(138,180,255,.85), 0 0 26px rgba(138,180,255,.55), 0 0 56px rgba(138,180,255,.35); }
    55%{ opacity:1; }
    100%{ opacity:0; box-shadow: inset 0 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0); }
  }
  .grid.highlight .card:nth-child(3n+1)::after { --delay:0ms; }
  .grid.highlight .card:nth-child(3n+2)::after { --delay:140ms; }
  .grid.highlight .card:nth-child(3n+3)::after { --delay:280ms; }
  @media (max-width:620px){
    .grid.highlight .card:nth-child(2n+1)::after { --delay: 0ms; }
    .grid.highlight .card:nth-child(2n+2)::after { --delay:160ms; }
  }
  @media (max-width:360px){
    .grid.highlight .card::after { --delay: 0ms; }
  }
  @media (prefers-reduced-motion:reduce){
    .grid.highlight .card::after{ animation:none; opacity:0; }
  }
</style>

</head>
<body>
  <div class="navchip-bar">
    <a class="navchip" href="./Doodles_trait-viewer.html?source=index" title="Apri Trait Viewer">
      <span class="shine">Trait Viewer</span>
    </a>
  </div>
  
  <main class="wrap">
    <header class="hero">
      <h1>ARB8i ðŸ’› Lab</h1>
      
      <div class="hero-id">
        <label for="idField" class="form-label">Doodles ID</label>
      
        <div class="hero-id-row">
          <!-- Host dove montiamo preview+input (e NON il bottone) -->
          <div id="idRowHost"></div>
      
          <!-- Contenitore del bottone + popover (il bottone verrÃ  montato qui) -->
          <div class="id-cta">
            <div id="idPopover" class="popover" role="status" aria-live="polite" aria-atomic="true"></div>
          </div>
        </div>
      
        <p class="sub" style="margin:6px 0 0">
          Missing your Doodle ID?
          <a id="tvLink" class="back shimmer idhelp" href="./Doodles_trait-viewer.html?source=index">Find it here!</a>
        </p>
        
        <p id="idError" class="id-error" role="status" aria-live="polite" style="display:none"></p>
      </div>
      <p class="tagline">Pick a vibe! Overlay the fun!</p>
    </header>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Nessun overlay nel manifest.</div>
  </main>

  <div class="footer-madeby">
    <a class="shimmer madeby-link" href="https://x.com/robottiandrea" target="_blank" rel="noopener">
      made by&nbsp;<span>ARB8i</span>â€“<span>@robottiandrea</span>
    </a>
  </div>

<script>
/* ====== DOM ====== */
const GRID = document.getElementById('grid');
const EMPTY = document.getElementById('empty');
const idError   = document.getElementById('idError');const idPopover  = document.getElementById('idPopover');
let popTimer = null;

/* ====== UI helpers ====== */
function nudgeGrid(){
  if(!GRID) return;
  GRID.classList.remove('highlight');
  void GRID.offsetWidth;
  GRID.classList.add('highlight');
  setTimeout(()=> GRID.classList.remove('highlight'), 1700);
}
function showPopover(msg){
  if(!idPopover) return;
  idPopover.textContent = msg;
  idPopover.classList.remove('show');
  void idPopover.offsetWidth;
  idPopover.classList.add('show');

  let fired = false;
  const onEnd = (e)=>{
    if(e.animationName !== 'popOutLeft') return;
    fired = true;
    idPopover.removeEventListener('animationend', onEnd);
    idPopover.classList.remove('show');
    nudgeGrid();
  };
  idPopover.addEventListener('animationend', onEnd);
  clearTimeout(popTimer);
  popTimer = setTimeout(()=>{
    if(!fired){
      idPopover.classList.remove('show');
      nudgeGrid();
    }
  }, 2100);
}

/* ====== Overlays grid ====== */
let overlays = null;

function cardHTML(item){
  const href = new URL('editor.html', location.href);
  href.searchParams.set('overlay', item.id);

  const thumb = item.thumb || `thumbs/${item.id}.png`;
  const badge = item.badge ? `<div class="badge" style="${item.badgeColor?`background:${item.badgeColor}`:''}">${item.badge}</div>` : '';
  const by = item.author ? `<div class="by">by ${item.author}</div>` : '';

  return `
  <article class="card">
    <div class="thumb">
      ${badge}
      <img loading="lazy" src="${thumb}" alt="${item.name||item.id}" />
    </div>
    <div class="titlebar">
      <div class="name">${item.name||item.id}</div>
      ${by}
    </div>
    <a class="cardlink" href="${href.toString()}"></a>
  </article>`;
}

function updateCardLinksWithId(id){
  document.querySelectorAll('a.cardlink').forEach(a=>{
    const u = new URL(a.getAttribute('href'), location.href);
    if(id==null){ u.searchParams.delete('id'); }
    else{ u.searchParams.set('id', id); }
    a.setAttribute('href', u.toString());
  });
}

function render(){
  if(!overlays || !overlays.items || overlays.items.length===0){
    GRID.innerHTML = '';
    if (EMPTY) EMPTY.style.display = '';
    return;
  }
  if (EMPTY) EMPTY.style.display = 'none';
  GRID.innerHTML = overlays.items.map(cardHTML).join('');
  const active = (OCNS && typeof OCNS.normalizeId === 'function')
  ? OCNS.normalizeId(localStorage.getItem('lastId'), 9999)
  : { valid:false };
updateCardLinksWithId(active.valid ? active.value : null);

}
/* ====== Riga ID condivisa: mount + init ====== */
const OCNS = window.OC;

if (OCNS && typeof OCNS.mountIdRow === 'function') {
  OCNS.mountIdRow('#idRowHost', {
    inputId: 'idField',
    previewId: 'idPreview',
    buttonId: 'idApplyBtn',
    buttonText: 'Itâ€™s me!',
    buttonClass: 'id-btn',
    buttonContainer: '.id-cta',
    showPreview: true,
    placeholder: '8929',
    maxLen: 4
  });
} else {
  console.warn('OC.mountIdRow non disponibile.');
}

let idCtrl = null;
if (OCNS && typeof OCNS.initIdControl === 'function') {
  idCtrl = OCNS.initIdControl({
    input: '#idField',
    preview: '#idPreview',
    button: '#idApplyBtn',
    defaultId: '8929',
    max: 9999,
    persistKey: 'lastId',
    urlParam: 'id',
    cleanUrlParam: true,
    linkUpdater: updateCardLinksWithId,
    onApply(id){
      updateCardLinksWithId(id);
      showPopover('Locked in! Pick a card!');
    },
    onValidChange(valid, st){
      updateCardLinksWithId(valid ? st.value : null);
    }
  });
} else {
  console.warn('OC.initIdControl non disponibile.');
}

(function () {
    const qs = new URLSearchParams(location.search);
    if (qs.get('lock') === '1') {
      // mostriamo lo stesso banner usato da "It's me!"
      showPopover('Locked in! Pick a card!');

      // pulizia: togli 'lock' dall'URL per non ri-triggerare al refresh
      qs.delete('lock');
      const clean = qs.toString();
      history.replaceState(null, '', location.pathname + (clean ? '?' + clean : ''));
    }
  })();




/* ====== Manifest overlays ====== */
async function loadManifest(){
  for (const url of ['./overlays/overlays.json','./overlays.json']){
    try{
      const r = await fetch(url);
      if(r.ok){ overlays = await r.json(); return; }
    }catch{}
  }
  overlays = { items: [] };
}
loadManifest().then(render).catch(()=>{ overlays = { items: [] }; render(); });
</script>
</body>
</html>
