<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Doodles Overlays â€” Gallery</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./styles/common.css">  
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f1115">

<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Doodles">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
</script>

<style>
  :root{
    /* solo variabili usate SOLO qui */
    --footer-space: calc(44px + env(safe-area-inset-bottom));
    --card-w:256px;
    --gap:18px;
    --id-width:112px;

    /* params sheen chip */
    --sheen-width:56px;
    --sheen-alpha:.18;
    --sheen-angle:-14deg;
    --sheen-from:-120%;
    --sheen-to:220%;
    --sheen-dur:5.2s;
    --sheen-delay:1.2s;
  }

  *{box-sizing:border-box}

  body{
    /* integrazione con common.css: qui aggiungiamo solo il layout della pagina */
    min-height:100svh;
    display:flex;
    flex-direction:column;
  }
  .wrap{ flex:1 0 auto; }

  /* centratura SOLO del blocco titolo+descrizione */
  .hero{ text-align:center; margin:8px 0 18px }
  .hero h1{ margin:0 0 6px; font-size:clamp(26px,3vw,36px); font-weight:600; }
  .hero p{ margin:0; font-size:clamp(13px,1.5vw,18px); line-height:1.35; color:var(--muted); }

  /* griglia cards */
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-w), var(--card-w)));
    gap:var(--gap);
    justify-content:center;
    justify-items:center;
    max-width: calc(3 * var(--card-w) + 2 * var(--gap));
    margin-inline:auto;
  }

  /* parti di card specifiche della gallery (il resto sta in common.css) */
  .thumb{ position:relative; aspect-ratio:1/1; background:#0d1016; }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .badge{
    position:absolute; top:8px; left:8px;
    padding:4px 8px; border-radius:10px; font-size:11px; font-weight:600;
    background:#fff; color:#0F1116;
  }
  .titlebar{ padding:10px 12px; border-top:1px solid var(--border);
             background:linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.15)); }
  .name{ font-size:15px; font-weight:600 }
  .by{ font-size:12px; color:var(--muted) }
  a.cardlink{ position:absolute; inset:0; display:block; text-decoration:none; color:inherit }
  .empty{ opacity:.8; text-align:center; border:1px dashed var(--border); border-radius:12px; padding:18px }

  /* nav chip sticky (solo gallery) */
  .navchip-bar{
    position:sticky;
    top:calc(12px + env(safe-area-inset-top));
    z-index:9999;
    display:flex; justify-content:center; padding:4px 0;
  }
  .navchip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 14px; border-radius:999px;
    background: color-mix(in oklab, var(--card) 85%, transparent);
    border:1px solid var(--border);
    backdrop-filter: blur(8px);
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    font:600 14px/1 'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text); text-decoration:none; white-space:nowrap;
    transition:border-color .15s ease, color .15s ease, transform .05s ease;
    position:relative; overflow:hidden;
  }
  .navchip:hover{ color:var(--acc); border-color:var(--acc); }
  .navchip:active{ transform: translateY(1px); }

  /* blocco ID centrato, ma label a sinistra */
  .hero-id{ display:inline-flex; flex-direction:column; align-items:center; }
  .hero-id .form-label{ align-self:flex-start; margin:0 0 6px; } /* il resto della label Ã¨ in common.css */

  /* input ID + stati (qui teniamo la versione compatta da gallery) */
  .id-input{
    width: var(--id-width);
    flex: 0 0 var(--id-width);
    height: 40px; padding:0 12px;
    border-radius:10px; border:1px solid var(--border);
    background:#0d1016; color:var(--text);
    font-size:16px; font-variant-numeric:tabular-nums; text-align:center;
  }
  .id-input.error{ border-color:#ff4d4f; box-shadow:0 0 0 2px rgba(255,77,79,.2); }
  .id-error{ margin:6px 0 0; color:#ff8082; font-size:13px; text-align:center; }

  /* anteprima tonda */
  .hero-id-row{ display:flex; justify-content:center; align-items:center; gap:8px; }
  .id-preview{
    width:40px; height:40px; flex:0 0 auto; border-radius:50%; overflow:hidden;
    border:1px solid var(--border); background:#0d1016; box-shadow:0 6px 16px rgba(0,0,0,.25);
    display:block; position:relative;
  }
  .id-preview img{ width:100%; height:100%; display:block; object-fit:cover; object-position:50% 35%; }
  .id-preview .id-badge{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font:600 12px/1 'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--muted);
  }
  .id-preview.loading::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    background-size:200% 100%; animation:shine 1.8s linear infinite;
  }

  /* bottone "Itâ€™s me!" + popover (solo qui) */
  .id-cta{ position:relative; display:flex; align-items:center; }
  .id-btn{
    height:40px; padding:0 14px; margin:0; border-radius:10px; border:1px solid var(--border);
    background:var(--acc); color:#0f1115; font-weight:700; font-family:'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    cursor:pointer; transition:transform .05s ease, filter .15s ease, opacity .15s;
  }
  .id-btn:hover{ filter:brightness(1.1); }
  .id-btn:active{ transform:translateY(1px); }
  .id-btn:disabled{ opacity:.45; cursor:not-allowed; }

  .popover{
    position:absolute; right: calc(100% + 10px); top:50%; transform: translateY(-50%) translateX(8px);
    z-index:1000; padding:8px 12px; border-radius:10px; border:1px solid var(--border);
    background: color-mix(in oklab, var(--card) 92%, transparent);
    box-shadow:0 8px 24px rgba(0,0,0,.35); white-space:nowrap; color:var(--text);
    font:600 13px/1.2 'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; opacity:0; pointer-events:none;
  }
  .popover::after{
    content:""; position:absolute; left:100%; top:50%; transform: translateY(-50%);
    width:0; height:0; border-top:6px solid transparent; border-bottom:6px solid transparent;
    border-left:6px solid var(--card); filter: drop-shadow(1px 0 0 var(--border));
  }
  .popover.show{
    animation: popInLeft .18s ease-out, popHold 1.6s linear .18s, popOutLeft .22s ease-in 1.78s forwards;
  }
  @keyframes popInLeft { from{opacity:0; transform:translateY(-50%) translateX(12px);} to{opacity:1; transform:translateY(-50%) translateX(0);} }
  @keyframes popHold { from{opacity:1} to{opacity:1} }
  @keyframes popOutLeft { to{opacity:0; transform:translateY(-50%) translateX(12px);} }

  /* Glow forte + onda sulle card (solo gallery) */
  .grid.highlight .card::after{
    content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none; z-index:2;
    box-shadow:
      inset 0 0 0 3px rgba(138,180,255,.75),
      0 0 22px rgba(138,180,255,.45),
      0 0 44px rgba(138,180,255,.25);
    opacity:0; animation: glowPulse 1.6s ease-in-out forwards; animation-delay: var(--delay, 0s);
  }
  @keyframes glowPulse{
    0%{ opacity:0; box-shadow: inset 0 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0); }
    18%{ opacity:1; box-shadow: inset 0 0 0 3px rgba(138,180,255,.85), 0 0 26px rgba(138,180,255,.55), 0 0 56px rgba(138,180,255,.35); }
    55%{ opacity:1; }
    100%{ opacity:0; box-shadow: inset 0 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0), 0 0 0 rgba(138,180,255,0); }
  }
  .grid.highlight .card:nth-child(3n+1)::after { --delay:0ms; }
  .grid.highlight .card:nth-child(3n+2)::after { --delay:140ms; }
  .grid.highlight .card:nth-child(3n+3)::after { --delay:280ms; }
  @media (max-width:620px){
    .grid.highlight .card:nth-child(2n+1)::after { --delay: 0ms; }
    .grid.highlight .card:nth-child(2n+2)::after { --delay:160ms; }
  }
  @media (max-width:360px){
    .grid.highlight .card::after { --delay: 0ms; }
  }
  @media (prefers-reduced-motion:reduce){
    .grid.highlight .card::after{ animation:none; opacity:0; }
  }
</style>

</head>
<body>
  <div class="navchip-bar">
    <a class="navchip" href="./Doodles_trait-viewer.html" title="Apri Trait Viewer">
      <span class="shine">Trait Viewer</span>
    </a>
  </div>
  
  <main class="wrap">
    <header class="hero">
      <h1>ARB8i ðŸ’› Lab</h1>
      <p>Pick a vibe! Overlay the fun!</p>
      <div class="hero-id">
      <label for="idField" class="form-label">Doodles ID</label>
      <div class="hero-id-row">
        <input id="idField" class="id-input" type="text"
               inputmode="numeric" pattern="[0-9]*" autocomplete="off"
               maxlength="4" placeholder="8929" />
        <div class="id-cta">
          <button id="idApplyBtn" class="id-btn" type="button" disabled>Itâ€™s me!</button>
          <div id="idPopover" class="popover" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>

      <div id="idPreview" class="id-preview" aria-hidden="true">
        <span class="id-badge">#â€”</span>
      </div>

      </div>
      <p class="sub" style="margin:6px 0 0">
        Missing your Doodle ID?
        <a id="tvLink" class="back shimmer idhelp" href="./Doodles_trait-viewer.html?source=index">Find it here!</a>
      </p>

      <p id="idError" class="id-error" role="status" aria-live="polite" style="display:none"></p>
    </div>
    </header>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Nessun overlay nel manifest.</div>
  </main>

  <div class="footer-madeby">
    <a class="shimmer madeby-link" href="https://x.com/robottiandrea" target="_blank" rel="noopener">
      made by&nbsp;<span>ARB8i</span>â€“<span>@robottiandrea</span>
    </a>
  </div>

<script>
const GRID = document.getElementById('grid');
const EMPTY = document.getElementById('empty');
const idField = document.getElementById('idField');
const idError = document.getElementById('idError');
const idPreview = document.getElementById('idPreview');
const idApplyBtn = document.getElementById('idApplyBtn');
const idPopover  = document.getElementById('idPopover');
const DEFAULT_PREVIEW_ID = '8929';  
let popTimer = null;

function nudgeGrid(){
  if(!GRID) return;
  GRID.classList.remove('highlight');      // reset se giÃ  presente
  void GRID.offsetWidth;                    // forza reflow per riavviare lâ€™animazione
  GRID.classList.add('highlight');
  setTimeout(()=> GRID.classList.remove('highlight'), 1700);
}
  
function showPopover(msg){
  if(!idPopover) return;

  // testo + reset animazione
  idPopover.textContent = msg;
  idPopover.classList.remove('show');
  void idPopover.offsetWidth; // reflow
  idPopover.classList.add('show');

  let fired = false;

  const onEnd = (e)=>{
    // Ignora popInLeft / popHold; aspetta SOLO popOutLeft
    if(e.animationName !== 'popOutLeft') return;
    fired = true;
    idPopover.removeEventListener('animationend', onEnd);
    idPopover.classList.remove('show');
    nudgeGrid(); // avvia il bagliore ora
  };

  // ðŸ‘‡ NIENTE { once:true } â€” ci sono piÃ¹ animationend
  idPopover.addEventListener('animationend', onEnd);

  // Failsafe nel caso l'evento non arrivi
  clearTimeout(popTimer);
  popTimer = setTimeout(()=>{
    if(!fired){
      idPopover.classList.remove('show');
      nudgeGrid();
    }
  }, 2100); // ~0.18 + 1.6 + 0.22
}



function setApplyButtonState(valid){
  if(!idApplyBtn) return;
  idApplyBtn.disabled = !valid;
}

function normalizeId(v){
  const s = String(v||'').trim().replace(/\D+/g,'');
  if(s==='') return { value:'', valid:false, empty:true };
  const n = parseInt(s,10);
  if(Number.isFinite(n) && n>=0 && n<=9999) return { value:String(n), valid:true, empty:false };
  return { value:s, valid:false, empty:false };
}

function updateCardLinksWithId(id){
  document.querySelectorAll('a.cardlink').forEach(a=>{
    const u = new URL(a.getAttribute('href'), location.href);
    if(id==null){ u.searchParams.delete('id'); }
    else{ u.searchParams.set('id', id); }
    a.setAttribute('href', u.toString());
  });
}

let overlays = null;

function cardHTML(item){
  const href = new URL('editor.html', location.href);
  href.searchParams.set('overlay', item.id);

  const thumb = item.thumb || `thumbs/${item.id}.png`;
  const badge = item.badge ? `<div class="badge" style="${item.badgeColor?`background:${item.badgeColor}`:''}">${item.badge}</div>` : '';
  const by = item.author ? `<div class="by">by ${item.author}</div>` : '';

  return `
  <article class="card">
    <div class="thumb">
      ${badge}
      <img loading="lazy" src="${thumb}" alt="${item.name||item.id}" />
    </div>
    <div class="titlebar">
      <div class="name">${item.name||item.id}</div>
      ${by}
    </div>
    <a class="cardlink" href="${href.toString()}"></a>
  </article>`;
}

function render(){
  if(!overlays || !overlays.items || overlays.items.length===0){
    GRID.innerHTML = '';
    if (EMPTY) EMPTY.style.display = '';
    return;
  }
  if (EMPTY) EMPTY.style.display = 'none';
  GRID.innerHTML = overlays.items.map(cardHTML).join('');
  const active = normalizeId(localStorage.getItem('lastId'));
  updateCardLinksWithId(active.valid ? active.value : null);

}

/* === Mini-preview Doodle #ID === */
/* --- METADATA â†’ indice idâ†’image (lazy, con cache) --- */
const META_SOURCES = ['./Doodles_all_metadata.json']; // aggiungi alternative se serve

function ipfsToHttps(u){
  if(!u) return u;
  if(u.startsWith('ipfs://')){
    const hash = u.replace('ipfs://','').replace(/^ipfs\//,'');
    return `https://dweb.link/ipfs/${hash}`;
  }
  return u;
}

function pickId(obj, fallbackKey){
  return obj?.id ?? obj?.tokenId ?? obj?.token_id ?? obj?.index ?? fallbackKey ?? null;
}
function pickImage(obj){
  return obj?.image ?? obj?.image_url ?? obj?.imageUrl ?? null;
}

async function ensureMetaIndex(){
  if(window.__metaIndexReady) return;
  for(const src of META_SOURCES){
    try{
      const r = await fetch(src, {cache:'no-store'});
      if(!r.ok) continue;
      const data = await r.json();
      const map = new Map();
      if(Array.isArray(data)){
        for(const it of data){
          const id = pickId(it);
          const img = pickImage(it);
          if(id!=null && img) map.set(String(id), ipfsToHttps(String(img)));
        }
      }else if(data && typeof data==='object'){
        for(const [k, v] of Object.entries(data)){
          // se Ã¨ shape { "1234": {"image": "..."} } oppure { "1234": "url" }
          const id = pickId(v, k);
          const img = (typeof v === 'string') ? v : pickImage(v);
          if(id!=null && img) map.set(String(id), ipfsToHttps(String(img)));
        }
      }
      if(map.size){
        window.__metaIndex = map;
        window.__metaIndexReady = true;
        return;
      }
    }catch(e){ /* silenzio */ }
  }
  window.__metaIndex = null;
  window.__metaIndexReady = true;
}

/* --- (opzionale) indice secondario leggero ./doodles/index.json --- */
async function ensureDoodleIndex(){
  if(window.__doodleIndexTried) return;
  window.__doodleIndexTried = true;
  try{
    const r = await fetch('./doodles/index.json', {cache:'no-store'});
    if(r.ok) window.__doodleIndex = await r.json();
  }catch{}
}

async function applyIdPreview(id){
  if(!idPreview) return;
  if(!id && id!==0){
    hideIdPreview();
    return;
  }
  const val = String(id);
  idPreview.style.display = 'block';
  idPreview.dataset.id = val;
  idPreview.classList.add('loading');
  idPreview.innerHTML = `<span class="id-badge">#${val}</span>`;

  const urls = await buildCandidateUrls(val);

  for (const url of urls){
    if(idPreview.dataset.id !== val) return; // ID cambiato nel frattempo
    const ok = await tryLoadIntoPreview(val, url);
    if(ok) break;
  }
  idPreview.classList.remove('loading');
}

function hideIdPreview(){
  if(!idPreview) return;
  idPreview.classList.remove('loading');
  // Mantieni il posto e mostra la preview di default
  applyIdPreview(DEFAULT_PREVIEW_ID);
}


async function buildCandidateUrls(id){
  const urls = [];
  const key = String(id);

  // 1) metadata principale
  await ensureMetaIndex();
  if(window.__metaIndex && window.__metaIndex.has(key)){
    urls.push(window.__metaIndex.get(key));
  }

  // 2) indice leggero opzionale
  await ensureDoodleIndex();
  if(window.__doodleIndex && window.__doodleIndex[key]){
    urls.push(String(window.__doodleIndex[key]));
  }

  // 3) pattern locali di fallback
  urls.push(
    `./doodles/thumbs/${key}.png`,
    `./doodles/thumbs/${key}.jpg`,
    `./doodles/${key}.png`,
    `./doodles/${key}.jpg`
  );
  return urls;
}


function tryLoadIntoPreview(id, url){
  return new Promise(resolve=>{
    const img = new Image();
    img.decoding = 'async';
    img.alt = `Anteprima Doodle #${id}`;
    img.onload = ()=>{
      if(idPreview.dataset.id === String(id)){
        idPreview.innerHTML = '';
        idPreview.appendChild(img);
        resolve(true);
      }else{
        resolve(false);
      }
    };
    img.onerror = ()=> resolve(false);
    img.src = url;
  });
}
// === CLICK SUL BOTTONE "IT'S ME!" ===
if(idApplyBtn){
  idApplyBtn.addEventListener('click', ()=>{
    const n = normalizeId(idField?.value);
    if(!n || !n.valid){
      if(idField){
        idField.classList.add('error');
        idError.textContent = 'Inserisci un numero da 0 a 9999';
        idError.style.display = '';
      }
      setApplyButtonState(false);
      return;
    }
    // salva e applica
    localStorage.setItem('lastId', n.value);
    updateCardLinksWithId(n.value);
    applyIdPreview(n.value);

    // feedback vicino al bottone
    showPopover('Locked in! Pick a card!');
    
  });
}

/* === Input ID: init & wiring === */
(function initIdField(){
  if(!idField) return;

  // Enter = click sul bottone (azione "apply")
  idField.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      idApplyBtn?.click();
    }
  });

  // Prefill da query ?id= o da localStorage; altrimenti usa default 8929
  const sp = new URLSearchParams(location.search);
  const fromQuery = sp.get('id');

  if(fromQuery != null){
    const nq = normalizeId(fromQuery);
    if(nq.valid){
      idField.value = nq.value;
      // Applica SUBITO se arriva da query (utile deep-link)
      localStorage.setItem('lastId', nq.value);
      applyIdPreview(nq.value);
      setApplyButtonState(true);
    }else{
      setApplyButtonState(false);
      applyIdPreview(DEFAULT_PREVIEW_ID);
    }
    // pulisci URL
    sp.delete('id');
    const q = sp.toString();
    history.replaceState(null, '', location.pathname + (q?('?'+q):''));
  }else{
    const last = localStorage.getItem('lastId');
    const nl = normalizeId(last);
    if(nl.valid){
      idField.value = nl.value;
      applyIdPreview(nl.value);     // mostra l'ID attivo salvato
      setApplyButtonState(true);
    }else{
      applyIdPreview(DEFAULT_PREVIEW_ID); // â† default sempre visibile
      setApplyButtonState(false);
    }
  }

  idField.addEventListener('input', ()=>{
    const n = normalizeId(idField.value);
    idField.value = n.value;

    if(n.empty){
      idField.classList.remove('error');
      idError.style.display = 'none';
      setApplyButtonState(false);
      applyIdPreview(DEFAULT_PREVIEW_ID);
      return;
    }

    if(n.valid){
      idField.classList.remove('error');
      idError.style.display = 'none';
      setApplyButtonState(true);
      applyIdPreview(n.value);  // preview LIVE mentre digiti
    }else{
      idField.classList.add('error');
      idError.textContent = 'Inserisci un numero da 0 a 9999';
      idError.style.display = '';
      setApplyButtonState(false);
      applyIdPreview(DEFAULT_PREVIEW_ID);
    }
  });
})();  // <-- questa riga ti manca

/* === Manifest overlays === */
async function loadManifest(){
  for (const url of ['./overlays/overlays.json','./overlays.json']){
    try{
      const r = await fetch(url);
      if(r.ok){ overlays = await r.json(); return; }
    }catch{}
  }
  overlays = { items: [] };
}

loadManifest().then(render).catch(()=>{ overlays = { items: [] }; render(); });
</script>
</body>
</html>
