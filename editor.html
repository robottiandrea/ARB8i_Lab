<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doodles Overlay — Editor</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#0f1115; --card:#171a21; --text:#eef2ff; --muted:#9aa3b2; --acc:#8ab4ff; --border:#232938; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font:15px/1.45 'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:820px; margin:0 auto; padding:28px}
  .header{display:flex; align-items:center; gap:12px; margin-bottom:10px}
  .back{display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); opacity:.85}
  .back:hover{opacity:1}
  h1{margin:0; font-size:20px; font-weight:600}
  .sub{color:var(--muted); font-size:12px}
  .badge{display:inline-block; margin-left:8px; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:600; background:#2b62ff}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
  input,button{width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#0d1016; color:var(--text)}
  .row{display:grid; grid-template-columns:1fr auto; gap:10px}
  .row2{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px}
  .btn{background:linear-gradient(180deg,#2b62ff,#2753d7); border:0; font-weight:600; cursor:pointer}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .status{min-height:22px; color:var(--muted); font-size:13px; margin-top:10px}

  /* viewer */
  .frame{position:relative; width:640px; max-width:100%; margin:18px auto 8px; border:1px dashed var(--border); border-radius:12px; background:#0d1016}
  .frame > img{position:relative; z-index:1; width:100%; height:auto; display:block}
  #overlayBox{position:absolute; inset:0; z-index:2; pointer-events:none}
  #overlayBox > svg{position:absolute; inset:0; width:100%; height:100%; display:block}

  .meta{font-size:12px; color:var(--muted); text-align:center}
</style>
</head>
<body>
  <main class="wrap">
    <div class="header">
      <a class="back" href="index.html">← Gallery</a>
      <div>
        <h1 id="ovName">Overlay</h1>
        <div class="sub"><span id="ovAuthor"></span><span id="ovBadge" class="badge" style="display:none"></span></div>
      </div>
    </div>

    <section class="card">
      <label for="tokenId">ID</label>
      <div class="row">
        <input id="tokenId" type="number" inputmode="numeric" min="1" placeholder="es. 8929" />
        <button id="go" class="btn">Apri immagine</button>
      </div>

      <div class="row2">
        <button id="dl" class="btn" title="Scarica PNG composito (base + overlay)">Scarica PNG</button>
        <label>Manica <input id="pickSleeve" type="color" value="#FFC3E0" /></label>
        <label>Skin   <input id="pickSkin"   type="color" value="#FFD1B9" /></label>
      </div>

      <div id="status" class="status"></div>

      <div class="frame" id="card">
        <img id="base" alt="Doodle PNG">
        <div id="overlayBox"></div>
      </div>
      <div class="meta"><span id="colorsDesc"></span></div>
    </section>
  </main>

<script>
/* ========= config di rete (come nel viewer) ========= */
const DEFAULT_CONTRACT = new URLSearchParams(location.search).get('contract')
  || '0x8a90CAb2b38dba80c64b7734e58Ee1dB38B8992e'; // Doodles mainnet

const RPCS = [
  'https://cloudflare-eth.com',
  'https://eth.drpc.org',
  'https://eth.llamarpc.com',
  'https://rpc.ankr.com/eth',
  'https://eth.public-rpc.com',
];

const IPFS_GW = [
  'https://ipfs.io/ipfs/',
  'https://cloudflare-ipfs.com/ipfs/',
  'https://dweb.link/ipfs/',
  'https://gateway.pinata.cloud/ipfs/'
];

/* ========= DOM refs ========= */
const $ = s => document.querySelector(s);
const baseImg = $('#base');
const overlayBox = $('#overlayBox');
const statusEl = $('#status');
const colorsDesc = $('#colorsDesc');
const ovName = $('#ovName');
const ovAuthor = $('#ovAuthor');
const ovBadge = $('#ovBadge');

/* ========= stato ========= */
let OVERLAYS = null;                 // manifest
let currentCfg = null;               // overlay scelto (da query)
let overlay = null;                  // <svg> iniettato
let NAME_TO_HEX = null;              // CSV
let META = null;                     // JSON id -> { Skin_colors, Sleeve_colors, ... }
let lastHexSkin = null, lastHexSleeve = null;
let currentObjectURL = null;

/* ========= util ========= */
function setStatus(t){ statusEl.textContent = t || ''; }
function pad32hex(n){ const h = BigInt(n).toString(16); return h.padStart(64,'0'); }
function decodeAbiString(hexdata){
  if(!hexdata || !hexdata.startsWith('0x')) return null;
  const h = hexdata.slice(2);
  if(h.length < 128) return null;
  const length = parseInt(h.slice(64,128),16);
  const start = 128, end = start + length*2;
  const s_hex = h.slice(start,end);
  try{ const bytes = s_hex.match(/.{1,2}/g).map(b=>parseInt(b,16));
       return new TextDecoder().decode(new Uint8Array(bytes)); }catch{ return null; }
}
async function rpcCall(method, params){
  const payload = { jsonrpc:'2.0', id:1, method, params };
  const headers = {'Content-Type':'application/json','Accept':'application/json'};
  for(const url of RPCS){
    try{ const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)}); if(!r.ok) continue;
         const d=await r.json(); if(d && !d.error) return d.result; }catch{}
  } return null;
}
function ipfsUrls(uri){
  if(typeof uri !== 'string') return [];
  if(uri.startsWith('ipfs://')){ const path = uri.replace('ipfs://',''); return IPFS_GW.map(gw=>gw+path); }
  return [uri];
}
async function fetchJsonAny(urls){
  for(const u of urls){ try{ const r=await fetch(u,{headers:{'Accept':'application/json'}}); if(r.ok){ return await r.json(); } }catch{} }
  return null;
}
async function fetchBlobAny(urls){
  for(const u of urls){ try{ const r=await fetch(u); if(r.ok) return await r.blob(); }catch{} }
  return null;
}

/* ========= manifest overlays ========= */
async function loadManifest(){
  for(const url of ['./overlays/overlays.json','./overlays.json']){
    try{ const r=await fetch(url); if(r.ok){ OVERLAYS=await r.json(); return; } }catch{}
  }
  throw new Error('overlays.json non trovato');
}
function getCfg(id){
  if(!OVERLAYS?.items) return null;
  return OVERLAYS.items.find(o=>o.id===id) || null;
}

/* ========= risorse locali (CSV + JSON + overlay) ========= */
function parseCsv(text){
  const m={}; text.replace(/\r\n/g,'\n').split('\n').forEach(line=>{
    line=line.trim(); if(!line || /^name\s*[,;\t]/i.test(line)) return;
    const [name,hexRaw]=line.split(/[,;\t]/).map(s=>s?.trim().replace(/^"+|"+$/g,''));
    if(!name||!hexRaw) return; const hex=hexRaw.startsWith('#')?hexRaw:('#'+hexRaw);
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(hex)) m[name]=hex;
  }); return m;
}
async function loadMaps(){
  if(!NAME_TO_HEX){
    const r=await fetch('./Corrispondenze_Nome_Hex.csv'); if(!r.ok) throw new Error('CSV non trovato');
    NAME_TO_HEX = parseCsv(await r.text());
  }
  if(!META){
    const r=await fetch('./Doodles_all_metadata.json'); if(!r.ok) throw new Error('JSON metadati non trovato');
    META = await r.json();
  }
}
async function loadOverlayFile(cfg){
  const urls = [`./overlays/${cfg.file}`, `./${cfg.file}`]; // fallback se non hai la cartella
  let svgText=null;
  for(const u of urls){ try{ const r=await fetch(u); if(r.ok){ svgText=await r.text(); break; } }catch{} }
  if(!svgText) throw new Error(`File overlay non trovato: ${cfg.file}`);
  overlayBox.innerHTML = svgText;
  overlay = overlayBox.querySelector('svg#overlay') || overlayBox.querySelector('svg');
  if(!overlay) throw new Error('Nel file overlay manca il tag <svg>');
  overlay.removeAttribute('width'); overlay.removeAttribute('height');
  overlay.setAttribute('preserveAspectRatio','xMidYMid meet');
}

/* ========= colori overlay ========= */
function setOverlayColors(hexSleeve, hexSkin){
  if(!overlay) return;
  const sleeveId = currentCfg?.sleeveId || 'Sleeve_fill';
  const skinId   = currentCfg?.skinId   || 'Skin_fill';

  if(hexSleeve){
    overlay.querySelectorAll(`#${sleeveId}, #${sleeveId} *`).forEach(n=>n.setAttribute('fill', hexSleeve));
    document.getElementById('pickSleeve').value = hexSleeve;
    lastHexSleeve = hexSleeve;
  }
  if(hexSkin){
    overlay.querySelectorAll(`#${skinId}, #${skinId} *`).forEach(n=>n.setAttribute('fill', hexSkin));
    document.getElementById('pickSkin').value = hexSkin;
    lastHexSkin = hexSkin;
  }
}

/* ========= pipeline: on-chain → IPFS → <img> ========= */
async function fetchAndShowBase(id){
  const data = '0xc87b56dd' + pad32hex(id); // tokenURI(uint256)
  const res  = await rpcCall('eth_call', [{to:DEFAULT_CONTRACT, data}, 'latest']);
  if(!res) throw new Error('RPC non disponibile');
  const tokenUri = decodeAbiString(res);
  if(!tokenUri) throw new Error('Decodifica tokenURI fallita');
  const meta = await fetchJsonAny(ipfsUrls(tokenUri));
  if(!meta) throw new Error('Metadata non disponibili');
  const imageUri = meta.image || meta.image_url || meta.imageIpfs;

  let blob = null;
  if(imageUri) blob = await fetchBlobAny(ipfsUrls(imageUri));
  if(!blob){
    // fallback locali
    for(const path of [`./doodles/${id}.png`, `./${id}.png`]){
      try{ const rr=await fetch(path); if(rr.ok){ blob=await rr.blob(); break; } }catch{}
    }
  }
  if(!blob) throw new Error('Immagine non disponibile (IPFS + fallback falliti)');

  if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
  currentObjectURL = URL.createObjectURL(blob);
  baseImg.crossOrigin = 'anonymous';
  baseImg.src = currentObjectURL;
}

/* ========= open by ID ========= */
async function openImage(){
  setStatus('Carico…'); const raw = $('#tokenId').value.trim(); const id = parseInt(raw,10);
  if(!Number.isFinite(id) || id<0){ setStatus('Inserisci un ID valido (≥1).'); return; }
  try{
    await Promise.all([loadMaps()]);
    await fetchAndShowBase(id);

    // colori da JSON locale
    const row = META[id];
    if(row){
      const nameSkin   = (row.Skin_colors   || row.skin_colors   || row.Skin   || '').trim();
      const nameSleeve = (row.Sleeve_colors || row.sleeve_colors || row.Sleeve || '').trim();
      const hexSkin   = NAME_TO_HEX[nameSkin];
      const hexSleeve = NAME_TO_HEX[nameSleeve];
      setOverlayColors(hexSleeve, hexSkin);
      colorsDesc.textContent = `Skin: ${nameSkin} ${hexSkin||''} • Sleeve: ${nameSleeve} ${hexSleeve||''}`;
    }else{
      colorsDesc.textContent = 'Colori non trovati nel JSON locale (puoi usare i picker).';
    }
    setStatus(`ID ${id}: immagine + overlay pronti.`);
  }catch(e){
    if(location.protocol==='file:') setStatus('Usa un server locale (es. py -m http.server 5500).');
    else setStatus('❌ ' + (e?.message || 'Errore'));
  }
}

/* ========= download composito ========= */
async function downloadPNG(){
  if(!overlay || !baseImg.naturalWidth){ setStatus('Apri prima un ID.'); return; }
  const W = baseImg.naturalWidth, H = baseImg.naturalHeight;
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(baseImg,0,0,W,H);

  const clone = overlay.cloneNode(true);
  const svgText = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([svgText],{type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  await new Promise((res,rej)=>{
    const img = new Image();
    img.onload=()=>{ ctx.drawImage(img,0,0,W,H); URL.revokeObjectURL(url); res(); };
    img.onerror=rej; img.src = url;
  });
  const a = document.createElement('a');
  a.download = `doodle_${$('#tokenId').value||'preview'}.png`;
  a.href = canvas.toDataURL('image/png'); a.click();
}

/* ========= init: carica overlay da query ========= */
(async function init(){
  try{
    await loadManifest();
    const p = new URLSearchParams(location.search);
    const ovId = p.get('overlay') || OVERLAYS.default || (OVERLAYS.items[0] && OVERLAYS.items[0].id);
    currentCfg = OVERLAYS.items.find(o=>o.id===ovId) || OVERLAYS.items[0];
    if(!currentCfg) throw new Error('Nessun overlay nel manifest');

    // UI header
    ovName.textContent = currentCfg.name || currentCfg.id;
    ovAuthor.textContent = currentCfg.author ? `by ${currentCfg.author}` : '';
    if(currentCfg.badge){ ovBadge.textContent = currentCfg.badge; ovBadge.style.display='inline-block'; if(currentCfg.badgeColor) ovBadge.style.background=currentCfg.badgeColor; }

    // carica file SVG scelto
    await loadOverlayFile(currentCfg);

    // se l’URL ha ?id=, aprilo subito
    const qid = p.get('id'); if(qid){ $('#tokenId').value = qid; await openImage(); }
  }catch(e){
    setStatus(e?.message || 'Errore inizializzazione.');
  }
})();

/* ========= events ========= */
$('#go').addEventListener('click', openImage);
$('#tokenId').addEventListener('keydown', e=>{ if(e.key==='Enter') openImage(); });
$('#dl').addEventListener('click', downloadPNG);
$('#pickSleeve').addEventListener('input', e=> setOverlayColors(e.target.value, null));
$('#pickSkin').addEventListener('input',   e=> setOverlayColors(null, e.target.value));

</script>
</body>
</html>
