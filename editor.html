<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doodles Overlay — Editor</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&display=swap" rel="stylesheet">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f1115">

<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Doodles">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
</script>

<style>
  /* ===== Theme ===== */
  :root{
    --bg:#0f1115; --card:#171a21; --text:#eef2ff; --muted:#9aa3b2;
    --acc:#8ab4ff; --border:#232938;

    /* Controls */
    --ctrl-h:40px;         /* altezza controlli (36/40/44 a gusto) */
    --ctrl-br:10px;        /* raggio */
    --ctrl-bw:1px;         /* spessore bordo */
    --ctrl-bc:#fff;        /* colore bordo (bianco come il bottone) */
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:15px/1.45 'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  .wrap{max-width:820px; margin:0 auto; padding:28px}

  /* Header */
  .header{display:flex; align-items:center; gap:12px; margin-bottom:10px}
  .back{display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); opacity:.85}
  .back:hover{opacity:1}
  h1{margin:0; font-size:20px; font-weight:600}
  .sub{color:var(--muted); font-size:12px}
  .badge{display:inline-block; margin-left:8px; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:600; background:#2b62ff; color:#fff}

  /* Card */
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.25)}

  /* Form */
  label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
  .row{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:stretch}

  /* Fix iOS: font >=16px per evitare blocchi tastiera/zoom */
  #tokenId{ font-size:16px; }
  /* Evita che qualche stile globale blocchi la selezione/focus */
  #tokenId{ -webkit-user-select:text; }
  html{ -webkit-text-size-adjust:100%; }

  /* Input number (stile + rimozione freccette) */
  .row input{
    width:100%;
    height:var(--ctrl-h);
    padding:0 12px; line-height:var(--ctrl-h);
    border:var(--ctrl-bw) solid var(--ctrl-bc);
    border-radius:var(--ctrl-br);
    background:#0d1016; color:var(--text);
    font-family:'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    appearance:none; -webkit-appearance:none; outline:none;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  input[type="number"]{ -moz-appearance:textfield; }
  .row input:focus{ box-shadow:0 0 0 2px rgba(138,180,255,.25); }

  /* Button outline (traduzione Tailwind → CSS) */
  .btn-outline{
    width:auto;
    height:var(--ctrl-h); line-height:var(--ctrl-h);
    padding:0 16px;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    border:var(--ctrl-bw) solid var(--ctrl-bc);
    border-radius:var(--ctrl-br);
    background:transparent; color:#fff;
    font-family:'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    font-weight:500; letter-spacing:.3px; font-size:14px;
    cursor:pointer; white-space:nowrap; transition:all .2s ease-in-out;
  }
  .btn-outline:hover:enabled{ background:#fff; color:#000; }
  .btn-outline:disabled{ opacity:.5; cursor:not-allowed; }

  .status{min-height:22px; color:var(--muted); font-size:13px; margin-top:10px}

  /* Viewer */
  .frame{position:relative; width:640px; max-width:100%; margin:18px auto 8px; border:1px dashed var(--border); border-radius:12px; background:#0d1016}
  #composite{display:block; width:100%; height:auto; border-radius:12px}

  /* Footer "made by" con shimmer */
  .footer-madeby{
    display:flex; justify-content:center; align-items:center;
    gap:0; margin:10px 0 0;
    font-family:'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .madeby-link{
    display:inline-flex; align-items:center; gap:0;
    text-decoration:none; color:inherit;
  }
  .madeby-link:hover{ text-decoration:underline; }

  .idhelp{
    font-size: 14px;
    font-weight: 600;
    letter-spacing: .2px;
    margin-left: 4px;
  }
  @media (min-width: 640px){
    .idhelp{ font-size: 15px; }
  }

  
  /* Testo lucido */
  .shimmer{
    --shine-start:rgba(192,192,192,.8);
    --shine-middle:rgba(255,255,255,1);
    --shine-end:rgba(192,192,192,.8);
    background-image:linear-gradient(120deg,
      var(--shine-start) 40%,
      var(--shine-middle) 50%,
      var(--shine-end) 60%
    );
    background-size:200% 100%;
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    animation:shine 8s linear infinite;
    letter-spacing:.2px;
  }
  
  @keyframes shine{
    0%{ background-position:200% 0 }
    100%{ background-position:-200% 0 }
  }

  @media (prefers-reduced-motion: reduce){
    .shimmer{ animation: none !important; }
  }

  /* --- Example state --- */
  #composite.is-example{
    filter: grayscale(50%) opacity(.9);
  }
  
  .example-badge{
    position:absolute; top:8px; left:8px;
    padding:4px 8px; border-radius:10px;
    font-size:11px; font-weight:700;
    color:#fff; background:rgba(0,0,0,.55);
    backdrop-filter: blur(2px);
    z-index:2; pointer-events:none;
  }
  
  .example-caption{
    text-align:center; font-size:12px; color:var(--muted);
    margin-top:6px;
  }
 
  /* OOPS badge */
  .oops-badge{
    position:absolute; top:8px; right:8px;
    padding:4px 10px; border-radius:999px;
    font-size:12px; font-weight:800;
    color:#fff; background:#ff4d4f;
    box-shadow:0 6px 18px rgba(0,0,0,.28);
    z-index:3; pointer-events:none;
    letter-spacing:.2px;
  }

  
</style>
</head>
<body>
  <main class="wrap">
    <div class="header">
      <a class="back" href="index.html">← Gallery</a>
      <div>
        <h1 id="ovName">Overlay</h1>
        <div class="sub"><span id="ovAuthor"></span><span id="ovBadge" class="badge" style="display:none"></span></div>
      </div>
    </div>

    <section class="card">
      <label for="tokenId">Doodles ID</label>
      <div class="row">
        <input id="tokenId" type="text" placeholder="8929" inputmode="numeric" pattern="[0-9]*" enterkeyhint="go" autocomplete="off" />
        <button id="go" class="btn-outline" aria-label="Show the image">Show Me!</button>
      </div>
      <p class="sub" style="margin:6px 0 0">
        Missing your Doodle ID?
        <a class="back shimmer idhelp" href="./Doodles_trait-viewer.html">Find it here!</a>
      </p>




      <div id="status" class="status"></div>

      <div class="frame">
        <div id="exampleBadge" class="example-badge" aria-hidden="true">EXAMPLE</div>
        <div id="oopsBadge" class="oops-badge" style="display:none" aria-hidden="true"></div>
        <img id="composite" alt="Preview">
      </div>

      <!-- Share controls (solo mobile, mostrato da JS) -->
      <div id="shareRow" class="share-row" style="display:none; gap:10px; justify-content:center; margin:12px 0 0;">
        <button id="shareX" class="btn-outline" type="button" disabled>Share!</button>
      </div>



      
      <!-- Made by (legato all'overlay) -->
      <div id="madeBy" class="footer-madeby" style="display:none">
        <a id="madeByLink" class="shimmer madeby-link" href="#" target="_blank" rel="noopener">
          made by&nbsp;<span id="mbName">author</span><span id="mbSep">–</span><span id="mbHandle">@handle</span>
        </a>
      </div>





    </section>
  </main>

<script>
/* ===== Network (RPC/IPFS) ===== */
const DEFAULT_CONTRACT = new URLSearchParams(location.search).get('contract')
  || '0x8a90CAb2b38dba80c64b7734e58Ee1dB38B8992e';

const RPCS = [
  'https://cloudflare-eth.com',
  'https://eth.drpc.org',
  'https://eth.llamarpc.com',
  'https://rpc.ankr.com/eth',
  'https://eth.public-rpc.com',
];
const IPFS_GW = [
  'https://ipfs.io/ipfs/',
  'https://cloudflare-ipfs.com/ipfs/',
  'https://dweb.link/ipfs/',
  'https://gateway.pinata.cloud/ipfs/',
];

/* ===== DOM ===== */
const $ = s => document.querySelector(s);
const statusEl = $('#status');
const imgEl = $('#composite');
const ovName = $('#ovName');
const ovAuthor = $('#ovAuthor');
const ovBadge = $('#ovBadge');
const madeBy = $('#madeBy');
const madeByLink = $('#madeByLink');
const mbName = $('#mbName');
const mbHandle = $('#mbHandle');
const mbSep = $('#mbSep');
const exBadge = document.querySelector('#exampleBadge');



/* ===== State ===== */
/* ===== Share (mobile only) ===== */
let MOBILE_SHARE = false;

function isMobileLike(){
  const ua = navigator.userAgent;
  const isIPhone  = /iPhone|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  // iPadOS spesso finge "Macintosh" ma ha touch
  const isIPad    = /iPad/i.test(ua) || (/Macintosh/i.test(ua) && 'ontouchend' in document);
  return isIPhone || isAndroid || isIPad;
}

function isAppleStandalone(){
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}
  
let OVERLAYS=null, currentCfg=null;
let NAME_TO_HEX=null, META=null;

/* ===== Utils ===== */
function setStatus(t){ statusEl.textContent = t || ''; }
function pad32hex(n){ const h = BigInt(n).toString(16); return h.padStart(64,'0'); }
function decodeAbiString(hexdata){
  if(!hexdata || !hexdata.startsWith('0x')) return null;
  const h = hexdata.slice(2); if(h.length<128) return null;
  const length = parseInt(h.slice(64,128),16);
  const s = h.slice(128, 128 + length*2);
  try{ const bytes = s.match(/.{1,2}/g).map(b=>parseInt(b,16)); return new TextDecoder().decode(new Uint8Array(bytes)); }catch{ return null; }
}
async function rpcCall(method, params){
  const payload={jsonrpc:'2.0',id:1,method,params}, headers={'Content-Type':'application/json','Accept':'application/json'};
  for(const url of RPCS){ try{ const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)}); if(!r.ok) continue; const d=await r.json(); if(d && !d.error) return d.result; }catch{} }
  return null;
}
function ipfsUrls(uri){ if(typeof uri!=='string') return []; if(uri.startsWith('ipfs://')){ const p=uri.replace('ipfs://',''); return IPFS_GW.map(g=>g+p); } return [uri]; }
async function fetchJsonAny(urls){ for(const u of urls){ try{ const r=await fetch(u,{headers:{'Accept':'application/json'}}); if(r.ok) return await r.json(); }catch{} } return null; }
async function fetchBlobAny(urls){ for(const u of urls){ try{ const r=await fetch(u); if(r.ok) return await r.blob(); }catch{} } return null; }

/* ===== Manifest & maps ===== */
async function loadManifest(){
  for(const url of ['./overlays/overlays.json','./overlays.json']){
    try{ const r=await fetch(url); if(r.ok){ OVERLAYS=await r.json(); return; } }catch{}
  }
  throw new Error('overlays.json not found');
}
function getCfg(id){ return OVERLAYS?.items?.find(o=>o.id===id) || null; }

function parseCsv(text){
  const m={}; text.replace(/\r\n/g,'\n').split('\n').forEach(line=>{
    line=line.trim(); if(!line || /^name\s*[,;\t]/i.test(line)) return;
    const [name,hexRaw]=line.split(/[,;\t]/).map(s=>s?.trim().replace(/^"+|"+$/g,''));
    if(!name||!hexRaw) return; const hex = hexRaw.startsWith('#')?hexRaw:('#'+hexRaw);
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(hex)) m[name]=hex;
  }); return m;
}
async function loadMaps(){
  if(!NAME_TO_HEX){ const r=await fetch('./Corrispondenze_Nome_Hex.csv'); if(!r.ok) throw new Error('CSV not found'); NAME_TO_HEX=parseCsv(await r.text()); }
  if(!META){ const r=await fetch('./Doodles_all_metadata.json'); if(!r.ok) throw new Error('Metadata JSON not found'); META=await r.json(); }
}

/* ===== Compose: base + overlay → dataURL ===== */
async function composeDataUrl(baseBlob, cfg, hexSleeve, hexSkin){
  const r = await fetch(`./overlays/${cfg.file}`);
  if(!r.ok) throw new Error(`Overlay not found: ${cfg.file}`);
  const svgText = await r.text();

  const temp = document.createElement('div'); temp.innerHTML = svgText;
  const svg = temp.querySelector('svg'); if(!svg) throw new Error('Overlay SVG missing <svg>');
  svg.removeAttribute('width'); svg.removeAttribute('height');
  svg.setAttribute('viewBox', svg.getAttribute('viewBox') || '0 0 1800 1800');
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  const sleeveId = cfg.sleeveId || 'Sleeve_fill';
  const skinId   = cfg.skinId   || 'Skin_fill';
  if(hexSleeve){ temp.querySelectorAll(`#${sleeveId}, #${sleeveId} *`).forEach(n=>n.setAttribute('fill', hexSleeve)); }
  if(hexSkin){   temp.querySelectorAll(`#${skinId}, #${skinId} *`).forEach(n=>n.setAttribute('fill', hexSkin)); }

  const baseUrl = URL.createObjectURL(baseBlob);
  const baseImg = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=baseUrl; });
  const W = baseImg.naturalWidth, H = baseImg.naturalHeight;
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(baseImg,0,0,W,H);
  URL.revokeObjectURL(baseUrl);

  const svgSerialized = new XMLSerializer().serializeToString(svg);
  const svgBlob = new Blob([svgSerialized], {type:'image/svg+xml'});
  const svgUrl = URL.createObjectURL(svgBlob);
  await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>{ ctx.drawImage(i,0,0,W,H); URL.revokeObjectURL(svgUrl); res(); }; i.onerror=rej; i.src=svgUrl; });

  return canvas.toDataURL('image/png');
}

/* ===== OOPS: match tratti SOLO nei value di attributes ===== */
function rowHasAnyNeedle(row, needles){
  if(!row || !Array.isArray(needles) || needles.length===0) return false;

  const keys = needles
    .map(n => (n??'').toString().trim().toLowerCase())
    .filter(Boolean);

  // 1) PRIMA cerchiamo nei value dell'array attributes
  const vals = Array.isArray(row.attributes)
    ? row.attributes
        .map(a => a && a.value)
        .filter(v => typeof v === 'string')
        .map(v => v.toLowerCase())
    : [];

  // 2) Se per qualche ID non ci sono attributes, fallback soft: altre stringhe piatte della riga
  if(vals.length === 0){
    vals.push(
      ...Object.values(row)
        .filter(v => typeof v === 'string')
        .map(v => v.toLowerCase())
    );
  }

  return keys.some(k => vals.some(v => v.includes(k)));
}

  
/* ===== Pipeline: on-chain → IPFS → compose ===== */
async function openImage(){
  setStatus('Cooking…');
  const shareBtn = document.getElementById('shareX');
  if (shareBtn) shareBtn.disabled = true;


 
  const raw = $('#tokenId').value.trim(); const id = parseInt(raw,10);
  if(!Number.isFinite(id) || id<0){ setStatus('Enter a valid ID (≥0).'); return; }

  try{
    await loadMaps();
    const data = '0xc87b56dd' + (BigInt(id).toString(16).padStart(64,'0'));
    const res  = await rpcCall('eth_call', [{to:DEFAULT_CONTRACT, data}, 'latest']);
    if(!res) throw new Error('RPC endpoint not responding');
    const tokenUri = decodeAbiString(res);
    if(!tokenUri) throw new Error('Could not read tokenURI');
    const meta = await fetchJsonAny(ipfsUrls(tokenUri));
    if(!meta) throw new Error('Metadata not available');

    let baseBlob = null;
    const imageUri = meta.image || meta.image_url || meta.imageIpfs;
    if(imageUri) baseBlob = await fetchBlobAny(ipfsUrls(imageUri));
    if(!baseBlob){
      for(const p of [`./doodles/${id}.png`, `./${id}.png`]){ try{ const rr=await fetch(p); if(rr.ok){ baseBlob=await rr.blob(); break; } }catch{} }
      if(!baseBlob) throw new Error('No Doodle image found');
    }

    const row = META[id] || {};
    const nameSkin   = (row.Skin_colors   || row.skin_colors   || row.Skin   || '').trim();
    const nameSleeve = (row.Sleeve_colors || row.sleeve_colors || row.Sleeve || '').trim();
    const hexSkin   = NAME_TO_HEX[nameSkin];
    const hexSleeve = NAME_TO_HEX[nameSleeve];

    const dataUrl = await composeDataUrl(baseBlob, currentCfg, hexSleeve, hexSkin);
    imgEl.src = dataUrl;
    // Modalità esempio OFF (abbiamo il render vero)
    if (MOBILE_SHARE && shareBtn) shareBtn.disabled = false;
    imgEl.classList.remove('is-example');
    if(exBadge) exBadge.style.display = 'none';
  
 

    imgEl.alt = `Doodle ${id} + ${currentCfg.name||currentCfg.id}`;
    setStatus(`Dood ${id}: cooked and ready! (Right-click or long-press to save)`);
    // --- OOPS badge, solo se overlay definisce sia tratti che messaggio ---
    const traits = Array.isArray(currentCfg.oopsTraits) ? currentCfg.oopsTraits : [];
    const message = (currentCfg.oopsMessage || '').trim();
    
    const showOops = (traits.length > 0) && message && rowHasAnyNeedle(row, traits);
    const oopsEl = document.getElementById('oopsBadge');
    
    if (oopsEl){
      if (showOops){
        oopsEl.textContent = message;
        oopsEl.style.display = 'inline-block';
      }else{
        oopsEl.style.display = 'none';
      }
    }

  }catch(e){
    if(location.protocol==='file:') setStatus('Please run a local server (e.g. python -m http.server 5500).');
    else setStatus('❌ ' + (e?.message || 'Something went wrong'));
    const oopsEl = document.getElementById('oopsBadge');
    if (oopsEl) oopsEl.style.display = 'none';
  }
}

function applyBadge(badgeEl, cfg){
  if(!badgeEl) return;
  if(!cfg || !cfg.badge){
    badgeEl.style.display = 'none';
    return;
  }
  badgeEl.textContent = cfg.badge;
  badgeEl.style.display = 'inline-block';

  // Sfondo dal JSON, se presente
  if(cfg.badgeColor) badgeEl.style.background = cfg.badgeColor;

  // Se il JSON fornisce un colore testo esplicito, usalo e basta
  if(cfg.badgeText){
    badgeEl.style.color = cfg.badgeText;
    return;
  }

  // Altrimenti calcola automaticamente bianco/nero in base allo sfondo
  try{
    const bg = getComputedStyle(badgeEl).backgroundColor;   // es. "rgb(255, 255, 255)"
    const m = bg && bg.match(/\d+(\.\d+)?/g);
    if(m){
      const [r,g,b] = m.map(Number);
      const yiq = (r*299 + g*587 + b*114) / 1000;           // luminanza YIQ
      badgeEl.style.color = yiq >= 150 ? '#000' : '#fff';
    }else{
      badgeEl.style.color = '#000';                         // fallback
    }
  }catch{
    badgeEl.style.color = '#000';
  }
}

// ===== Fix tastiera iPad in PWA =====
(function fixIOSPWAKeyboard(){
  // Siamo in PWA (standalone) e su iPad (user agent Apple con touch)
  const inPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  const isiPad = /iPad|Macintosh/.test(navigator.userAgent) && 'ontouchend' in document;
  if(!(inPWA && isiPad)) return;

  const el = document.getElementById('tokenId');
  if(!el) return;

  // Trucco: rendi l'input readonly finché l'utente non tocca → poi togli readonly e focus
  el.setAttribute('readonly', 'readonly');

  // Primo tap (dito) sblocca tastiera
  el.addEventListener('touchend', function onTouch(){
    el.removeAttribute('readonly');
    // piccolo delay per permettere a iOS di “capire”
    setTimeout(()=>{
      el.focus();
      // sposta il cursore in fondo (forza la comparsa tastiera su alcune versioni)
      const v = el.value; el.value=''; el.value=v;
    }, 0);
    el.removeEventListener('touchend', onTouch);
  }, {passive:true});

  // Fallback per Apple Pencil / trackpad: pointerdown
  el.addEventListener('pointerdown', function onPD(){
    if (el.hasAttribute('readonly')) {
      el.removeAttribute('readonly');
      setTimeout(()=>el.focus(), 0);
    }
  }, {passive:true});
})();
  
/* ===== Init ===== */
(async function init(){
  try{
    await loadManifest();
    const p = new URLSearchParams(location.search);
    const ovId = p.get('overlay')
      || localStorage.getItem('lastOverlay')
      || OVERLAYS.default
      || (OVERLAYS.items[0] && OVERLAYS.items[0].id);

    currentCfg = getCfg(ovId) || OVERLAYS.items[0];
    if (currentCfg?.id) localStorage.setItem('lastOverlay', currentCfg.id);

    ovName.textContent = currentCfg.name || currentCfg.id;
    ovAuthor.textContent = currentCfg.author ? `by ${currentCfg.author}` : '';
    localStorage.setItem('lastOverlay', currentCfg.id);

    const viewerLink = document.getElementById('viewerLink');
    if (viewerLink) {
      const u = new URL('./Doodles_trait-viewer.html', location.href);
      u.searchParams.set('overlay', currentCfg.id);
      viewerLink.href = u.toString();
    }

    applyBadge(ovBadge, currentCfg);

    // Footer "made by"
    (function(){
      const name = (currentCfg.author || '').toString().trim();
      const handleRaw = (currentCfg.authorHandle || currentCfg.x || currentCfg.twitter || '').toString().trim();
      const handle = handleRaw.replace(/^@/, '');
      const url = (currentCfg.authorUrl && currentCfg.authorUrl.trim())
               || (handle ? `https://x.com/${handle}` : '');

      const hasName = !!name;
      const hasHandle = !!handle;

      if(!hasName && !hasHandle){
        madeBy.style.display = 'none';
        return;
      }

      madeBy.style.display = 'flex';
      mbName.textContent = hasName ? name : (hasHandle ? '@'+handle : '');
      mbSep.style.display = (hasName && hasHandle) ? '' : 'none';

      if(hasHandle){
        mbHandle.textContent = '@' + handle;
        mbHandle.style.display = '';
      }else{
        mbHandle.style.display = 'none';
      }

      if(url){
        madeByLink.href = url;
        madeByLink.style.pointerEvents = '';
      }else{
        madeByLink.removeAttribute('href');
        madeByLink.style.pointerEvents = 'none';
      }
    })();

    
    MOBILE_SHARE = (isMobileLike() || isAppleStandalone()) && !!navigator.share;
    const shareRow = document.getElementById('shareRow');
    const shareBtn = document.getElementById('shareX');
    if (MOBILE_SHARE) {
      shareRow.style.display = 'flex';
      shareBtn.disabled = true;
    } else {
      shareRow.style.display = 'none';
    }


    const thumb = currentCfg.thumb || `thumbs/${currentCfg.id}.png`;
    imgEl.src = thumb;
    imgEl.classList.add('is-example');
    if(exBadge) exBadge.style.display = 'inline-block';
    imgEl.alt = currentCfg.name || currentCfg.id;

    const oopsEl = document.getElementById('oopsBadge');
    if (oopsEl) oopsEl.style.display = 'none';

    const qid = p.get('id');
    if(qid){ $('#tokenId').value = qid; await openImage(); }

  }catch(e){
    setStatus(e?.message || 'Init error');
  }
})();



function dataUrlToBlob(dataURL){
  const [head, body] = dataURL.split(',');
  const mime = (/data:(.*?);/.exec(head) || [,'application/octet-stream'])[1];
  const bstr = head.includes(';base64') ? atob(body) : decodeURIComponent(body);
  const buf = new Uint8Array(bstr.length);
  for (let i=0;i<bstr.length;i++) buf[i] = bstr.charCodeAt(i);
  return new Blob([buf], {type:mime});
}

async function shareMobileX(){
  if (!MOBILE_SHARE) return;

  const img = document.getElementById('composite');
  const tokenEl = document.getElementById('tokenId');

  const id = parseInt((tokenEl?.value || '').trim(), 10);
  const layoutName = (currentCfg?.name || currentCfg?.id || 'Overlay') + '';
  const text = Number.isFinite(id)
    ? `Ho applicato "${layoutName}" a Doodle #${id} — prova anche tu!`
    : `Guarda il mio "${layoutName}"`;

  try{
    if (!navigator.share) return;

    // Prepara il file PNG
    const src = img?.src;
    if (!src) return;
    const blob = src.startsWith('data:') ? dataUrlToBlob(src) : await (await fetch(src)).blob();
    const file = new File([blob], 'doodle.png', { type: 'image/png' });

    // Alcuni iPad PWA restituiscono false qui anche se poi funziona.
    const canFiles = (typeof navigator.canShare === 'function')
      ? navigator.canShare({ files:[file] })
      : true; // se canShare non esiste, proviamo lo stesso

    if (canFiles) {
      await navigator.share({ text, files:[file] });
      return;
    }

    // Workaround: prova comunque con i file (su iPad PWA spesso va)
    try {
      await navigator.share({ text, files:[file] });
      return;
    } catch (_) {
      // Ultimo fallback: apri share sheet senza allegato, almeno consente di postare il testo
      await navigator.share({ text });
    }
  }catch(e){
    console.error('Share fallita:', e);
  }
}


   
    

/* ===== Events ===== */
$('#go').addEventListener('click', openImage);
$('#tokenId').addEventListener('keydown', e=>{ if(e.key==='Enter') openImage(); });
const shareBtn2 = document.getElementById('shareX');
if (shareBtn2) shareBtn2.addEventListener('click', shareMobileX);

  
</script>
</body>
</html>





